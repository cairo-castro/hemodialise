# üöÄ Guia de Deploy - Dokploy Production
## Sistema Hemodi√°lise - Qualidade HD

**Dom√≠nio**: `qualidadehd.direcaoclinica.com.br`

---

## üìã Pr√©-requisitos

1. **Servidor Dokploy** instalado e funcionando
2. **Banco de Dados MariaDB** j√° existente no Dokploy:
   - Host: `qualidade-productionqualidade-l2xbgb`
   - Database: `hemodialise_gqa`
   - User: `Usr_QltGest@2025`
   - Password: `Qlt!H0sp#2025`
3. **Reposit√≥rio Git** (GitHub/GitLab/Gitea)
4. **Chaves necess√°rias**:
   - `APP_KEY` (ser√° gerado)
   - `JWT_SECRET` (ser√° gerado)

---

## üîë Passo 1: Gerar Chaves de Seguran√ßa

### Gerar APP_KEY

No seu ambiente local, execute:

```bash
php artisan key:generate --show
```

Voc√™ receber√° algo como:
```
base64:XyZ123abc456DEF789ghi012JKL345mno678PQR901stu234VWX567yza890=
```

### Gerar JWT_SECRET

```bash
php artisan jwt:secret --show
```

Ou gere manualmente:
```bash
openssl rand -base64 64
```

**‚ö†Ô∏è IMPORTANTE**: Guarde essas chaves em local seguro!

---

## üì¶ Passo 2: Preparar o Reposit√≥rio

### 1. Commit os arquivos de produ√ß√£o

Certifique-se que estes arquivos est√£o no reposit√≥rio:

- ‚úÖ `Dockerfile.production`
- ‚úÖ `docker/entrypoint.production.sh`
- ‚úÖ `.env.production` (como refer√™ncia - **N√ÉO commitar valores reais**)

```bash
git add Dockerfile.production docker/entrypoint.production.sh .env.production
git commit -m "feat: adiciona configura√ß√£o de produ√ß√£o para Dokploy"
git push origin main
```

### 2. Estrutura esperada no reposit√≥rio

```
/
‚îú‚îÄ‚îÄ Dockerfile.production       # Dockerfile otimizado
‚îú‚îÄ‚îÄ docker/
‚îÇ   ‚îú‚îÄ‚îÄ entrypoint.production.sh
‚îÇ   ‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ default.conf
‚îÇ   ‚îî‚îÄ‚îÄ supervisor/
‚îÇ       ‚îî‚îÄ‚îÄ supervisord.conf
‚îú‚îÄ‚îÄ app/
‚îú‚îÄ‚îÄ resources/
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ ... (resto da aplica√ß√£o Laravel)
```

---

## üéØ Passo 3: Criar Aplica√ß√£o no Dokploy

### 3.1. Login no Dokploy

Acesse seu painel Dokploy em: `https://seu-dokploy.com`

### 3.2. Criar Nova Aplica√ß√£o

1. Clique em **"Create Application"**
2. Escolha **"Git Provider"**
3. Configura√ß√µes:

**General Settings:**
```
Application Name: hemodialise-qualidade
Repository: https://github.com/cairo-castro/hemodialise
Branch: main
Build Path: /
```

**Build Type:**
```
Build Type: Dockerfile
Dockerfile Path: Dockerfile.production
Docker Context Path: .
Docker Build Stage: production
```

### 3.3. Configurar Vari√°veis de Ambiente

V√° para a aba **"Environment"** e adicione:

```env
# Application
APP_NAME=Sistema Hemodi√°lise - Qualidade
APP_ENV=production
APP_KEY=base64:COLE_SUA_CHAVE_AQUI
APP_DEBUG=false
APP_URL=https://qualidadehd.direcaoclinica.com.br
APP_TIMEZONE=America/Sao_Paulo
APP_LOCALE=pt_BR

# Database - MariaDB Dokploy
DB_CONNECTION=mysql
DB_HOST=qualidade-productionqualidade-l2xbgb
DB_PORT=3306
DB_DATABASE=hemodialise_gqa
DB_USERNAME=Usr_QltGest@2025
DB_PASSWORD=Qlt!H0sp#2025
DB_CHARSET=utf8mb4
DB_COLLATION=utf8mb4_unicode_ci

# Session & Cache
SESSION_DRIVER=database
SESSION_LIFETIME=480
SESSION_ENCRYPT=true
SESSION_DOMAIN=.direcaoclinica.com.br
SESSION_SECURE_COOKIE=true
CACHE_STORE=database

# Queue
QUEUE_CONNECTION=database
FILESYSTEM_DISK=local

# JWT
JWT_SECRET=COLE_SEU_JWT_SECRET_AQUI
JWT_TTL=60
JWT_REFRESH_TTL=20160

# Logging
LOG_CHANNEL=stack
LOG_STACK=daily
LOG_LEVEL=warning

# Container Flags
RUN_MIGRATIONS=true
RUN_SEEDERS=false

# Security
TRUSTED_PROXIES=*
SANCTUM_STATEFUL_DOMAINS=qualidadehd.direcaoclinica.com.br
```

---

## üåê Passo 4: Configurar Dom√≠nio

### 4.1. Adicionar Dom√≠nio no Dokploy

1. V√° para a aba **"Domains"**
2. Clique em **"Add Domain"**
3. Configure:

```
Domain: qualidadehd.direcaoclinica.com.br
Port: 80
HTTPS: Enabled (Dokploy configurar√° SSL automaticamente via Let's Encrypt)
```

### 4.2. Configurar DNS

No seu provedor de DNS (ex: Cloudflare, GoDaddy), adicione:

```
Tipo: A
Nome: qualidadehd
Valor: [IP-DO-SERVIDOR-DOKPLOY]
TTL: Auto ou 300
```

**Ou com subdom√≠nio completo:**

```
Tipo: CNAME
Nome: qualidadehd.direcaoclinica.com.br
Valor: seu-servidor-dokploy.com
TTL: Auto ou 300
```

---

## üöÄ Passo 5: Deploy Inicial

### 5.1. Primeira Deployment

1. Clique no bot√£o **"Deploy"**
2. Aguarde o build (pode levar 5-10 minutos na primeira vez)
3. Monitore os logs na aba **"Logs"**

### 5.2. Verificar Health Check

Ap√≥s o deploy, verifique:

```bash
curl https://qualidadehd.direcaoclinica.com.br/up
```

Deve retornar: `OK`

---

## üóÑÔ∏è Passo 6: Configurar Banco de Dados (Primeira vez)

### 6.1. Verificar Migra√ß√µes

O container j√° roda as migra√ß√µes automaticamente (`RUN_MIGRATIONS=true`).

### 6.2. Rodar Seeders (Se necess√°rio)

SSH no servidor Dokploy:

```bash
# Encontrar o container
docker ps | grep hemodialise

# Entrar no container
docker exec -it [CONTAINER_ID] sh

# Rodar seeders
su-exec laravel php artisan db:seed --class=RolesAndPermissionsSeeder
su-exec laravel php artisan db:seed --class=UserSeeder
```

**Ou altere temporariamente** a vari√°vel de ambiente:
```env
RUN_SEEDERS=true
```

E fa√ßa um novo deploy. Depois **desabilite**:
```env
RUN_SEEDERS=false
```

---

## üìä Passo 7: Configurar Recursos e Healthcheck

### 7.1. Configurar Resources

V√° para **Advanced > Cluster Settings > Swarm Settings**

**Health Check:**
```json
{
  "Test": [
    "CMD",
    "curl",
    "-f",
    "http://localhost/up"
  ],
  "Interval": 30000000000,
  "Timeout": 10000000000,
  "StartPeriod": 60000000000,
  "Retries": 3
}
```

**Update Config (Rollback autom√°tico):**
```json
{
  "Parallelism": 1,
  "Delay": 10000000000,
  "FailureAction": "rollback",
  "Order": "start-first"
}
```

### 7.2. Configurar Recursos (Opcional)

**Resources:**
```json
{
  "Limits": {
    "NanoCPUs": 2000000000,
    "MemoryBytes": 2147483648
  },
  "Reservations": {
    "NanoCPUs": 500000000,
    "MemoryBytes": 536870912
  }
}
```

---

## üîÑ Passo 8: Configurar Auto Deploy (Opcional)

### Op√ß√£o 1: Webhook do Git

1. V√° para **Deployments** tab
2. Copie a **Webhook URL**
3. No GitHub: **Settings > Webhooks > Add webhook**
4. Cole a URL
5. Selecione eventos: `push` no branch `main`

### Op√ß√£o 2: GitHub Actions + Docker Registry

**Recomendado para produ√ß√£o!** Veja se√ß√£o "Deployment Avan√ßado" abaixo.

---

## üìÅ Passo 9: Configurar Volumes (Persist√™ncia)

### 9.1. Adicionar Volumes

V√° para **Advanced > Volumes** e adicione:

**Volume 1 - Storage:**
```
Type: Volume
Name: hemodialise-storage
Container Path: /var/www/html/storage
```

**Volume 2 - Bootstrap Cache:**
```
Type: Volume
Name: hemodialise-cache
Container Path: /var/www/html/bootstrap/cache
```

---

## ‚úÖ Passo 10: Verifica√ß√£o Final

### 10.1. Checklist

- [ ] Aplica√ß√£o responde em `https://qualidadehd.direcaoclinica.com.br`
- [ ] SSL/HTTPS funcionando (certificado v√°lido)
- [ ] Login de usu√°rio funcionando
- [ ] Banco de dados conectado
- [ ] Logs sem erros cr√≠ticos
- [ ] Health check retornando OK
- [ ] Assets (CSS/JS) carregando corretamente

### 10.2. Testar Funcionalidades

```bash
# Testar API
curl https://qualidadehd.direcaoclinica.com.br/api/health

# Ver logs
# No Dokploy: Logs tab ou:
docker logs -f [CONTAINER_ID]

# Entrar no container
docker exec -it [CONTAINER_ID] sh
```

---

## üî• Deployment Avan√ßado (Recomendado para Produ√ß√£o)

### Por que usar CI/CD?

- ‚úÖ Build fora do servidor (n√£o consome recursos do Dokploy)
- ‚úÖ Deployment mais r√°pido
- ‚úÖ Zero downtime
- ‚úÖ Rollback autom√°tico em caso de erro

### GitHub Actions Setup

#### 1. Criar Docker Hub Account

1. Crie conta em https://hub.docker.com
2. Crie reposit√≥rio: `seu-usuario/hemodialise`
3. Gere Access Token: **Account Settings > Security > New Access Token**

#### 2. Adicionar Secrets no GitHub

No seu reposit√≥rio GitHub: **Settings > Secrets > Actions**

```
DOCKERHUB_USERNAME: seu-usuario
DOCKERHUB_TOKEN: seu-access-token
```

#### 3. Criar Workflow

Crie `.github/workflows/deploy-production.yml`:

```yaml
name: Deploy Production

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and Push
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.production
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/hemodialise:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/hemodialise:${{ github.sha }}
          platforms: linux/amd64
```

#### 4. Configurar Dokploy para Docker Image

No Dokploy, **altere** as configura√ß√µes:

```
Source Type: Docker
Docker Image: seu-usuario/hemodialise:latest
```

#### 5. Configurar Auto Deploy no Docker Hub

1. Docker Hub > Seu Reposit√≥rio > **Webhooks**
2. Nome: `Dokploy Production`
3. Webhook URL: [Cole a URL do Dokploy Deployments tab]

---

## üêõ Troubleshooting

### Problema: Container n√£o inicia

**Verificar:**
```bash
# Ver logs
docker logs [CONTAINER_ID]

# Verificar vari√°veis
docker exec [CONTAINER_ID] env | grep APP_KEY
```

### Problema: Erro de conex√£o com banco

**Verificar:**
```bash
# Testar conex√£o
docker exec [CONTAINER_ID] nc -zv qualidade-productionqualidade-l2xbgb 3306

# Ver credenciais
docker exec [CONTAINER_ID] env | grep DB_
```

### Problema: Assets n√£o carregam

**Solu√ß√£o:**
```bash
docker exec [CONTAINER_ID] su-exec laravel php artisan storage:link
docker exec [CONTAINER_ID] su-exec laravel php artisan optimize
```

### Problema: Permiss√µes

**Solu√ß√£o:**
```bash
docker exec [CONTAINER_ID] chown -R laravel:laravel storage bootstrap/cache
docker exec [CONTAINER_ID] chmod -R 775 storage bootstrap/cache
```

---

## üîÑ Manuten√ß√£o

### Atualizar Aplica√ß√£o

1. Fazer push para o reposit√≥rio
2. Dokploy far√° deploy automaticamente (se webhook configurado)
3. Ou clicar em **"Deploy"** manualmente

### Backup do Banco de Dados

```bash
# SSH no servidor
ssh user@dokploy-server

# Backup
docker exec qualidade-productionqualidade-l2xbgb \
  mysqldump -u Usr_QltGest@2025 -p'Qlt!H0sp#2025' hemodialise_gqa > backup.sql

# Restaurar
docker exec -i qualidade-productionqualidade-l2xbgb \
  mysql -u Usr_QltGest@2025 -p'Qlt!H0sp#2025' hemodialise_gqa < backup.sql
```

### Limpar Caches

```bash
docker exec [CONTAINER_ID] su-exec laravel php artisan optimize:clear
docker exec [CONTAINER_ID] su-exec laravel php artisan optimize
```

### Ver Logs

```bash
# Logs em tempo real
docker logs -f [CONTAINER_ID]

# Logs Laravel
docker exec [CONTAINER_ID] tail -f storage/logs/laravel.log

# Logs do Queue Worker
docker exec [CONTAINER_ID] tail -f storage/logs/worker.log
```

---

## üìû Suporte

Para problemas ou d√∫vidas:

- **Documenta√ß√£o Dokploy**: https://docs.dokploy.com
- **Logs**: Sempre verifique os logs primeiro
- **Health Check**: Use `/up` para verificar status

---

## ‚ú® Recursos Habilitados

‚úÖ **HTTPS/SSL autom√°tico** (Let's Encrypt via Traefik)  
‚úÖ **Zero Downtime** deployment  
‚úÖ **Auto Rollback** em caso de falha  
‚úÖ **Health Checks** autom√°ticos  
‚úÖ **Queue Workers** (2 workers)  
‚úÖ **Task Scheduler** (cron jobs)  
‚úÖ **OPcache** otimizado para produ√ß√£o  
‚úÖ **Logs estruturados** (daily rotation)  
‚úÖ **Compress√£o Gzip** no Nginx  
‚úÖ **Cache de assets** (1 ano)  

---

**üéâ Deploy conclu√≠do! Sua aplica√ß√£o est√° em produ√ß√£o.**
