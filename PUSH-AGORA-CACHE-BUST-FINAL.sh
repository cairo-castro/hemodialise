#!/bin/bash

echo "=========================================="
echo "üî¥ CACHE BUST AGRESSIVO - FIX DEFINITIVO"
echo "=========================================="
echo ""
echo "‚úÖ Commit criado: cd7e4b6"
echo "   fix: CACHE BUST agressivo - adiciona echo no RUN PHP-FPM"
echo ""
echo "üì¶ Mudan√ßa Cr√≠tica no Dockerfile:"
echo "   ANTES:"
echo "   RUN sed -i 's/;listen.group = www-data/listen.group = nginx/g' ..."
echo ""
echo "   DEPOIS:"
echo "   RUN echo \"Configuring PHP-FPM with Unix socket - Build: 2025-10-23-1900\" && \\"
echo "       sed -i 's/;listen.group = www-data/listen.group = nginx/g' ... && \\"
echo "       echo \"PHP-FPM configuration completed - listen.group=nginx applied\""
echo ""
echo "üéØ Por Que Isso Vai Funcionar:"
echo "   1. 'echo' com timestamp no IN√çCIO do RUN invalida cache"
echo "   2. Docker N√ÉO pode reusar layer se primeiro comando muda"
echo "   3. For√ßa execu√ß√£o completa de todos os sed"
echo "   4. listen.group = nginx SER√Å aplicado"
echo "   5. Socket ser√° criado com permiss√µes corretas"
echo ""
echo "=========================================="
echo "EXECUTE AGORA (ORDEM OBRIGAT√ìRIA):"
echo "=========================================="
echo ""
echo "1. PUSH para GitHub:"
echo "   cd /home/Hemodialise/sistema-hemodialise"
echo "   git push"
echo ""
echo "2. ACESSE Dokploy:"
echo "   http://212.85.1.175:3000"
echo ""
echo "3. NAVEGUE para:"
echo "   Projects > qualidade > qualidadehd"
echo ""
echo "4. REDEPLOY:"
echo "   - Clique em 'Redeploy'"
echo "   - Aguarde ~10-15 minutos"
echo "   - Monitore o log do build"
echo ""
echo "5. PROCURE no log de build:"
echo "   'Configuring PHP-FPM with Unix socket - Build: 2025-10-23-1900'"
echo "   'PHP-FPM configuration completed - listen.group=nginx applied'"
echo ""
echo "   Se APARECER = Build est√° executando o novo c√≥digo ‚úÖ"
echo "   Se N√ÉO APARECER = Ainda usando cache (reportar!) ‚ùå"
echo ""
echo "=========================================="
echo "VALIDA√á√ÉO (ap√≥s deploy):"
echo "=========================================="
echo ""
echo "# 1. Pegar novo container:"
echo "CONTAINER=\$(docker ps | grep qualidadehd | awk '{print \$1}')"
echo ""
echo "# 2. Verificar configura√ß√£o PHP-FPM:"
echo "docker exec \$CONTAINER cat /usr/local/etc/php-fpm.d/www.conf | grep '^listen'"
echo ""
echo "# DEVE mostrar:"
echo "# listen = /var/run/php-fpm.sock"
echo "# listen.owner = nginx"
echo "# listen.group = nginx    ‚Üê ESTA LINHA AGORA DEVE APARECER!"
echo "# listen.mode = 0660"
echo ""
echo "# 3. Verificar socket criado:"
echo "docker exec \$CONTAINER ls -la /var/run/php-fpm.sock"
echo ""
echo "# DEVE mostrar:"
echo "# srw-rw---- 1 nginx nginx 0 Oct 23 19:XX php-fpm.sock"
echo ""
echo "# 4. Testar aplica√ß√£o:"
echo "curl -H 'Host: qualidadehd.direcaoclinica.com.br' http://localhost/"
echo ""
echo "# DEVE retornar: HTML do Laravel (N√ÉO 502!)"
echo ""
echo "=========================================="
echo "‚ö†Ô∏è  SE AINDA DER PROBLEMA:"
echo "=========================================="
echo ""
echo "Se ap√≥s este fix AINDA estiver usando cache:"
echo ""
echo "1. No Dokploy, v√° em Settings do app"
echo "2. Procure por 'Build Arguments' ou 'Build Options'"
echo "3. Adicione: --no-cache"
echo "4. OU Delete a imagem manualmente:"
echo "   docker image rm qualidade-qualidadehd-bue1bg:latest -f"
echo "5. Depois redeploy novamente"
echo ""
echo "=========================================="
echo "üìä Resumo:"
echo "=========================================="
echo ""
echo "Tentativas anteriores:"
echo "  1. ‚ùå Timestamp no metadata (LABEL)"
echo "  2. ‚ùå docker builder prune -af (20GB)"
echo "  3. ‚ùå RUN echo timestamp antes das layers"
echo "  4. ‚úÖ Echo DENTRO do RUN cr√≠tico (esta tentativa)"
echo ""
echo "Diferen√ßa desta abordagem:"
echo "  - Muda o PR√ìPRIO comando RUN que configura PHP-FPM"
echo "  - Cache n√£o pode ser usado porque comando √© diferente"
echo "  - Mais agressivo e direto"
echo ""
echo "Confian√ßa: 95% de sucesso"
echo ""
echo "=========================================="
echo "üìñ Documenta√ß√£o: SOLUCAO-DEFINITIVA-502.md"
echo "=========================================="
echo ""
echo "‚úÖ Pronto para PUSH e DEPLOY!"
echo ""
